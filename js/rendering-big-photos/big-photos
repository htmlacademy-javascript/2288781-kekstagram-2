import { сloseOnEscapeKeyDown } from '../utils.js'

// МОДУЛЬ, КОТОРЫЙ БУДЕТ ОТВЕЧАТЬ ЗА ОТРИСОВКУ ОКНА С ПОЛНОРАЗМЕРНЫМ ИЗОБРАЖЕНИЕМ

// /**
// Задача - реализовать сценарий просмотра фотографий в полноразмерном режиме.
// В таком режиме пользователь получает несколько дополнительных возможностей:
// - детально рассмотреть изображение,
// - поставить «лайк»,
// - почитать комментарии, оставленные другими пользователями
// */

// Для отображения окна нужно удалять класс hidden у элемента .big-picture
const bigPicture = document.querySelector('.big-picture');

// и каждый раз заполнять его данными о конкретной фотографии:
// - адрес изображения url подставьте как src изображения внутри блока .big-picture__img
const bigPictureImage = bigPicture.querySelector('.big-picture__img img');
// - количество лайков likes подставьте как текстовое содержание элемента .likes-count
const likesCount = bigPicture.querySelector('.likes-count');
// - количество показанных комментариев подставьте как текстовое содержание элемента .social__comment-shown-count
const socialCommentsShownCount = bigPicture.querySelector('.social__comment-shown-count');
// - общее количество комментариев к фотографии comments подставьте как текстовое содержание элемента .social__comment-total-count
const socialCommentsTotalCount = bigPicture.querySelector('.social__comment-total-count');
// - cписок комментариев под фотографией: комментарии должны вставляться в блок .social__comments.
const socialComments = bigPicture.querySelector('.social__comments');
// - описание фотографии description вставьте строкой в блок .social__caption
const socialCaption = bigPicture.querySelector('.social__caption');

// Шаблон комментария
//  Разметка каждого комментария должна выглядеть так:
// <li class="social__comment">
//   <img
//     class="social__picture"
//     src="{{аватар}}"
//     alt="{{имя комментатора}}"
//     width="35" height="35">
//   <p class="social__text">{{текст комментария}}</p>
// </li>
const commentTemplate = document.querySelector('#comment').content.querySelector('.social__comment');

// Кнопка для загрузки новой порции комментариев
const commentsLoader = bigPicture.querySelector('.comments-loader');

// Форма для отправки комментария
const socialFooterText = bigPicture.querySelector('.social__footer-text');
const commentFragment = document.createDocumentFragment();

// Кнопка для выхода из полноэкранного просмотра изображения
const pictureCloseButton = document.querySelector('.big-picture__cancel');
const pictureCancel = document.querySelector('#picture-cancel');

// Кнопка для загрузки новой порции комментариев
const socialCommentsLoader = bigPicture.querySelector('.social__comments-loader');


let alreadyRenderedComments; // уже отправленные комментарии
const renderStatistic = () => {
  socialCommentsShownCount.textContent = alreadyRenderedComments;
};

let localComments; // сами комментарии
const renderLoaderButton = () => {
  if(localComments.length) {
    commentsLoaderNode.classList.remove('hidden');
  } else {
    commentsLoaderNode.classList.add('hidden');
  }
};

const renderComments = () => {
  const DocumentFragment = document.createDocumentFragment();
  localComments.splice(0, 5).forEach(( { avatar, name, message } ) => {
    const newComment = socialComment.cloneNode(true);
    const getImage = newComment.querySelector('.social__picture');
    getImage.src = avatar;
    getImage.alt = name;
    newComment.querySelector('.social__text').textContent = message;
    DocumentFragment.appendChild(newComment);
    alreadyRenderedComments++;
  });
  socialComments.appendChild(DocumentFragment);
  renderStatistic();
  renderLoaderButton();
};

// ОТРИСОВКА ОКНА С ПОЛНОРАЗМЕРНЫМ ИЗОБРАЖЕНИЕМ
export const showBigPicture = ( { url, description, likes, comments } ) => {
  bigPicture.classList.remove('hidden');

  bigPictureImage.src = url;
  bigPictureImage.alt = description;
  likesCount.textContent = likes;
  socialCommentsTotalCount.textContent = comments;
  socialCaption.textContent = description;
  socialCommentsTotalCount.textContent = comments.length;
  socialComments.innerHTML = '';

  localComments = [...comments];
  alreadyRenderedComments = 0;
  renderComments();
};

// Выход из просмотра полноразмерного изображения
const closeBigPicture = () => {
  bigPicture.classList.add('hidden');
};

const onBigPictureEscKeyDown = (evt) => {
  closeOnEscKeyDown(evt, () => {
    closeBigPicture();
  });

  document.removeEventListener('keydown', onBigPictureEscKeyDown);
};

pictureCancel.addEventListener('click', () => {
  closeBigPicture();
});

// Загрузка новой порции комментариев
socialCommentsLoader.addEventListener('click', () => {
  renderComments();
});
